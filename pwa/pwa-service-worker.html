<!DOCTYPE html>
<html>
<head>
  <link rel="manifest" href="/blog/manifest.json">
  <link rel="preload" href="/blog/css/main.css" as="style" type="text/css" onload="this.rel='stylesheet'" crossorigin="anonymous">
  <link rel="preload" href="/blog/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/blog/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <meta name="theme-color" content="#2196f3">
  <!-- Add to home screen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="#2196f3">
  <meta name="apple-mobile-web-app-title" content="Saiwas Blog">
  <link rel="apple-touch-icon" href="/blog/images/icons/icon-152x152.png">
  <!-- Add to home screen for windows -->
  <meta name="msapplication-TileImage" content="/blog/images/icons/icon-144x144.png">
  <meta name="msapplication-TileColor" content="#2196f3">
  <noscript>
    <link rel="stylesheet" href="/blog/css/main.css">
  </noscript>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1 user-scalable=1">
  <title>Saiwas Blog | Progressive Web App - Service Worker</title>
  <style>
    .avatar {
      width: 100px;
      height: 100px;
      margin: 0 auto;
      border-radius: 10%;
    }

    #site-header {
      background-color: black;
      border-top: 5px solid #424242;
    }

    .container {
      display: flex;
      flex-direction: column;
      max-width: 600px;
      margin: 0 auto;
    }

    #main-content {
      display: flex;
      flex-direction: column;
      padding: 1.5em 0;
      margin: 0 auto;
      max-width: 1250px;
    }

    #footer {
      background-color: black;
      color: white;
      padding: 1.5rem;
    }

    @media (min-width: 800px) {
      body {
        display: grid;
        grid-template-columns: 1fr 5fr;
        grid-template-rows: 1fr;
        grid-template-areas: "header main" "footer main"
      }
      .avatar {
        width: 150px;
        height: 150px;
      }
      .container {
        grid-area: main;
        margin: 0;
        max-width: none;
        position: relative;
      }
      #categories {
        margin: 0;
        overflow: scroll;
      }
      #categories ul {
        padding: 5px 2em;
      }
      #categories ul li {
        border: 2px solid gold;
        border-radius: 15px;
        display: inline-block;
        margin: 5px;
        min-width: 15%;
        height: 2em;
      }
      #categories ul li:hover {
        border-style: ridge;
      }
      .category-cnt {
        margin: 0.5em 1em;
      }
      #main-content {
        padding: 0;
      }
      .page-navigation a {
        font-size: unset;
      }
    }
  </style>
</head>


<body>
  <header id="site-header" role="banner">
    <div class="wrapper">
  <img class="avatar" data-src="https://avatars2.githubusercontent.com/u/3829027?s=460&v=4" alt="saiwas-avatar">
  <h1 class="site-title">
    <a rel="author" href="/blog/">Saiwas</a>
  </h1>
  <p>I am a web developer.</p>
  <p>Always hungry to keep learning.</p>
</div>

  </header>
  <section class= "container">
    <article id="post-detail">
  <header>
    <h2 class="post-title">
      <a href="#">Progressive Web App - Service Worker</a>
    </h2>
    <p class="category">pwa</p>
  </header>
  <div class="excerpt">
    <h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>éšç€Web çš„å¿«é€Ÿå‘å±•, ç”¨æˆ·å¯¹æµè§ˆç½‘ç«™çš„è¦æ±‚ä¹Ÿé€æ­¥æé«˜, è€Œå¦‚ä»Šç§»åŠ¨è®¾å¤‡çš„ä¸æ–­æ™®åŠ, åŒæ—¶ <code class="highlighter-rouge">Native App</code> åœ¨ç”¨æˆ·ä½“éªŒä¸Šå¯¹ Webé¢†åŸŸçš„å†²å‡», æ›´å¤šçš„ç”¨æˆ·éƒ½å¸Œæœ›åœ¨é¢„è§ˆç½‘é¡µæ—¶èƒ½å¤Ÿæƒ³æ‰“å¼€appä¸€æ ·çš„æ–¹ä¾¿, å“åº”ä¸€æ ·çš„è¿…é€Ÿ. äºæ˜¯å‰ç«¯çš„æ”»åŸç‹®ä¸ºäº†ä¼˜åŒ–å‡ åæ¯«ç§’è€Œè´¹å°½å¿ƒæ€.</p>

<p>ç»ˆäº, W3Cç»„ç»‡æ—©åœ¨ 2014å¹´ 5æœˆ åœ¨ <strong>æŒä¹…çš„ç¦»çº¿ç¼“å­˜</strong> è¿™ä¸ªæ–¹é¢æå‡ºäº† <code class="highlighter-rouge">Service Worker</code> è¿™ä¸€ä¸ª H5 API.</p>

<hr />

<h2 id="ä»€ä¹ˆæ˜¯-service-worker-sw">ä»€ä¹ˆæ˜¯ <code class="highlighter-rouge">Service Worker</code> (SW)</h2>
<blockquote>
  <p><code class="highlighter-rouge">SW</code> æ˜¯æµè§ˆå™¨åœ¨åå°è¿è¡Œçš„è„šæœ¬ï¼Œåœ¨æ³¨å†Œå¹¶å®‰è£…æˆåŠŸå, è¿è¡Œäºæµè§ˆå™¨åå°, ä¸ç½‘é¡µåˆ†å¼€, ä¸å—é¡µé¢åˆ·æ–°çš„å½±å“, ä½†æ˜¯å®ƒè¿˜å¯ä»¥ç›‘å¬å’Œæˆªæ‹¦ä½œç”¨åŸŸèŒƒå›´å†…æ‰€æœ‰é¡µé¢çš„ <code class="highlighter-rouge">HTTP</code> è¯·æ±‚.</p>
</blockquote>

<hr />

<h2 id="sw-ä½œç”¨">SW ä½œç”¨</h2>
<ol>
  <li>ç½‘ç»œä»£ç†ï¼Œè½¬å‘è¯·æ±‚ï¼Œä¼ªé€ å“åº”</li>
  <li>ç¦»çº¿ç¼“å­˜</li>
  <li>æ¶ˆæ¯æ¨é€</li>
  <li>åå°æ¶ˆæ¯ä¼ é€’</li>
</ol>

<p><img src="http://ravindranaik.com/wp-content/uploads/2018/02/1fbdd59d923c44cb.png" alt="Service Worker" /></p>

<hr />

<h2 id="sw-ç”Ÿå‘½å‘¨æœŸ">SW ç”Ÿå‘½å‘¨æœŸ</h2>

<ul>
  <li>æ³¨å†Œ(register/install)
    <ul>
      <li>åœ¨ <code class="highlighter-rouge">main js(app.js/bundle.js/...)</code> é‡Œ, æˆ‘ä»¬éœ€è¦å…ˆæ³¨å†Œæˆ‘ä»¬çš„ <code class="highlighter-rouge">sw.js</code>
        <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--</span> <span class="nx">register</span> <span class="nx">our</span> <span class="s2">`sw.js`</span><span class="p">.</span> <span class="o">--&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'load'</span><span class="p">,</span> <span class="k">async</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="s1">'serviceWorker'</span> <span class="k">in</span> <span class="nb">navigator</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span>
        <span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'sw.js'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">registration</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`SW registered! scope: </span><span class="p">${</span><span class="nx">registration</span><span class="p">.</span><span class="nx">scope</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="c">&lt;!--</span> <span class="nx">If</span> <span class="nx">the</span> <span class="nx">SW</span> <span class="nx">install</span> <span class="nx">fail</span><span class="p">,</span> <span class="nx">it</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">redundanted</span> <span class="nx">automaticly</span><span class="p">.</span> <span class="o">--&gt;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`SW register fail`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>å®‰è£…ä¸­(installing)
    <ul>
      <li>è¿™æ—¶å€™ä¼šè§¦å‘ <em>SW</em> çš„<code class="highlighter-rouge">install</code> äº‹ä»¶.</li>
      <li>åœ¨ <code class="highlighter-rouge">install</code> äº‹ä»¶ä¸­, æˆ‘ä»¬å¯ä»¥è°ƒç”¨ <code class="highlighter-rouge">event.waitUntil()</code>, <code class="highlighter-rouge">self.skipWaiting()</code> ä¸¤ä¸ªäº‹ä»¶.
        <ul>
          <li>event.waitUntil() â€“&gt; ä¼ å…¥ä¸€ä¸ª Promise ä¸ºå‚æ•°, ç­‰åˆ°è¯¥ Promise ä¸º resolve çŠ¶æ€ä¸ºæ­¢.</li>
          <li>self.skipWaiting() â€“&gt; <code class="highlighter-rouge">self</code> æ˜¯å½“å‰ context çš„ global å˜é‡, æ‰§è¡Œè¯¥æ–¹æ³•è¡¨ç¤ºå¼ºåˆ¶å½“å‰å¤„åœ¨ waiting çŠ¶æ€çš„ Service Worker è¿›å…¥ activate çŠ¶æ€.
            <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--</span> <span class="nx">sw</span><span class="p">.</span><span class="nx">js</span> <span class="o">--&gt;</span>
<span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'install'</span><span class="p">,</span> <span class="k">async</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="c">&lt;!--</span> <span class="nx">Perform</span> <span class="nx">install</span> <span class="nx">steps</span> <span class="o">--&gt;</span>
<span class="nx">e</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
  <span class="c">&lt;!--</span> <span class="nx">using</span> <span class="nx">cache</span><span class="o">/</span><span class="nx">creating</span> <span class="nx">cache</span> <span class="nx">files</span> <span class="o">--&gt;</span>
    <span class="c">&lt;!--</span> <span class="nx">Perform</span> <span class="nx">cache</span> <span class="nx">steps</span> <span class="nx">code</span> <span class="o">--&gt;</span>
  <span class="c">&lt;!--</span> <span class="nx">or</span> <span class="nx">we</span> <span class="nx">can</span> <span class="nx">skip</span> <span class="nx">the</span> <span class="nx">installing</span> <span class="nx">step</span> <span class="o">--&gt;</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">skipWaiting</span><span class="p">();</span>
<span class="p">)</span>
<span class="p">});</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>å®‰è£…å(installed)
    <ul>
      <li>Service Worker å·²ç»å®Œæˆäº†å®‰è£…, å¹¶ä¸”ç­‰å¾…å…¶ä»–çš„ Service Worker çº¿ç¨‹è¢«å…³é—­ã€‚</li>
    </ul>
  </li>
  <li>æ¿€æ´»ä¸­(activating)
    <ul>
      <li>åœ¨è¿™ä¸ªçŠ¶æ€ä¸‹æ²¡æœ‰è¢«å…¶ä»–çš„ Service Worker æ§åˆ¶çš„å®¢æˆ·ç«¯, å…è®¸å½“å‰çš„ worker å®Œæˆå®‰è£…, å¹¶ä¸”æ¸…é™¤äº†å…¶ä»–çš„ worker ä»¥åŠå…³è”ç¼“å­˜çš„æ—§ç¼“å­˜èµ„æº, ç­‰å¾…æ–°çš„ Service Worker çº¿ç¨‹è¢«æ¿€æ´».</li>
      <li>è¿™é‡Œä¼šè§¦å‘ <code class="highlighter-rouge">activate</code> äº‹ä»¶, å¹¶ä¸”å¯ä»¥è°ƒç”¨ <code class="highlighter-rouge">event.waitUntil()</code>, <code class="highlighter-rouge">self.clients.claim()</code> ä¸¤ä¸ªäº‹ä»¶
        <ul>
          <li>event.waitUntil()  â€“&gt; ä¼ å…¥ä¸€ä¸ª <code class="highlighter-rouge">Promise</code> ä¸ºå‚æ•°, ç­‰åˆ°è¯¥ <code class="highlighter-rouge">Promise</code> ä¸º <code class="highlighter-rouge">resolve</code> çŠ¶æ€ä¸ºæ­¢.</li>
          <li>self.clients.claim()  â€“&gt; åœ¨ activate äº‹ä»¶å›è°ƒä¸­æ‰§è¡Œè¯¥æ–¹æ³•è¡¨ç¤ºå–å¾—é¡µé¢çš„æ§åˆ¶æƒ, è¿™æ ·ä¹‹åæ‰“å¼€é¡µé¢éƒ½ä¼šä½¿ç”¨ç‰ˆæœ¬æ›´æ–°çš„ç¼“å­˜. æ—§çš„ Service Worker è„šæœ¬ä¸å†æ§åˆ¶ç€é¡µé¢, ä¹‹åä¼šè¢«åœæ­¢.
            <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'activate'</span><span class="p">,</span> <span class="nx">evnet</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
<span class="c1">// Code here, we use to clean up/update the cache.</span>
<span class="p">)</span>
<span class="p">})</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>æ¿€æ´»å(activated)
    <ul>
      <li>æ­¤æ—¶, æˆ‘ä»¬å¯ä»¥å¤„ç†åŠŸèƒ½æ€§çš„äº‹ä»¶ â€“ è¯·æ±‚/æ¨é€/åå°åŒæ­¥(fetch/push/sync)
        <ul>
          <li>è¯·æ±‚(fetch) â€“ å½“æµè§ˆå™¨å‘èµ·è¯·æ±‚æ—¶ï¼Œä¼šè§¦å‘ <code class="highlighter-rouge">fetch</code> äº‹ä»¶, SWæ¿€æ´»å, é€šè¿‡è¿™ä¸ªäº‹ä»¶æ‹¦æˆªç½‘ç»œè¯·æ±‚</li>
          <li>æ¨é€(push) â€“ push äº‹ä»¶æ˜¯ä¸ºæ¶ˆæ¯æ¨é€å‡†å¤‡çš„. è¿™é‡Œä¼šç»“åˆ <code class="highlighter-rouge">Push API</code> å’Œ <code class="highlighter-rouge">Notification API</code> ä½¿ç”¨</li>
          <li>åå°åŒæ­¥(sync) â€“ sync äº‹ä»¶ç”± background sync (åå°åŒæ­¥)å‘å‡º.
            <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'fetch'</span><span class="p">,</span> <span class="k">async</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="c1">// code here should handle network-first or cache-first</span>
<span class="nx">e</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>åºŸå¼ƒ(redundant)
    <ul>
      <li>è¿™ä¸ªçŠ¶æ€è¡¨ç¤ºä¸€ä¸ª Service Worker çš„ç”Ÿå‘½å‘¨æœŸç»“æŸ.</li>
    </ul>
  </li>
</ul>

<p><img src="https://developers.google.com/web/fundamentals/primers/service-workers/images/sw-lifecycle.png" alt="Service Workerç”Ÿå‘½å‘¨æœŸ" /></p>

<hr />

<p>PS. This blog is a <code class="highlighter-rouge">PWA</code> Demo. Please have a look if you want.</p>

  </div>
  <span class="post-date">30/May/2018</span>
</article>

<div class="page-navigation">
  
  <a class="prev" href="/blog/pwa/pwa-manifest.html">&laquo; Progressive Web App - Manifest.json</a>
   
</div>

  </section>
  <footer id="footer">
    <div class="contact wrapper">
  <h3>CONTACT</h3>
  <ul class="social-media-list">
    <li class="fab fa-github">
      <a href="https://github.com/saiwas">
        saiwas
      </a>
    </li>
    <li class="fa fa-envelope">
      <a href="mailto:johnnysaiwas@gmail.com">
        johnnysaiwas@gmail.com
      </a>
    </li>
    <li class="fab fa-qq">
      <a href="/">
        464781456
      </a>
    </li>
  </ul>
  <p>A designer knows he has achieved perfection not when there is nothing left to add, but when there is nothing left to take
    away.</p>
  <p id="legal">
    Copyright (c) 2018 Saiwas | Powered by
    <a href="http://jekyllrb.com">Jekyll</a> &amp;
    <a href="http://github.com">GitHub</a> | designed &amp; build by
    <a href="http://saiwas.github.io">saiwas</a>
  </p>
</div>
  </footer>
</body>
<script type="text/javascript" src="/blog/js/application.js" async defer></script>
</html>
